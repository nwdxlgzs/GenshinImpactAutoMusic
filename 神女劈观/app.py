import ctypes
import pynput
import time
import pygetwindow as gw
ctr = pynput.keyboard.Controller()

# Press keyboard.
def tap(key):
    ctr.press(key)
    ctr.release(key)

# check Admin
def is_admin():
    try:
        return ctypes.windll.shell32.IsUserAnAdmin()
    except:
        return False

localMark = 0

# Periodically check the window to prevent wrong keystrokes.
def loopGenshinImpact():
    global localMark
    localMark += 1
    while True:
        name = gw.getActiveWindow().title
        lname = name.lower()
        if(name == "原神" or (lname.find("genshin") != -1 and lname.find("impact") != -1)):
            break
        else:
            print("窗口为原神时程序将再次运行。")
            time.sleep(1)

# Check for the first time to run the program.
while True:
    time.sleep(1)
    if is_admin()==False:
        print("请用管理员权限运行，否则无法正常模拟按键。")
        time.sleep(1)
        continue
    name = gw.getActiveWindow().title
    lname = name.lower()
    if(name == "原神" or (lname.find("genshin") != -1 and lname.find("impact") != -1)):
        print("窗口检查为：原神，程序开始加载。")
        print("曲目为：神女劈观，程序开发者：难忘的旋律official@bilibili，欢迎关注！")
        break
    else:
        print("窗口为原神时程序将运行。")

# Tap Data:((keys),(delay:msf))
TapData=[
(("C","N",),(0,0,0)),
(("B",),(0,1,17)),
(("N",),(0,1,20)),
(("D",),(0,2,14)),
(("J",),(0,3,23)),
(("H",),(0,4,6)),
(("J",),(0,5,2)),
(("H",),(0,5,4)),
(("J",),(0,5,16)),
(("H",),(0,5,18)),
(("J",),(0,5,28)),
(("H",),(0,6,0)),
(("J",),(0,7,2)),
(("H",),(0,7,14)),
(("C","N","H",),(0,10,0)),
(("H",),(0,11,12)),
(("J",),(0,12,12)),
(("H",),(0,12,16)),
(("G",),(0,12,20)),
(("J",),(0,13,9)),
(("H",),(0,13,28)),
(("C","N","D",),(0,15,5)),
(("S",),(0,16,13)),
(("G",),(0,17,3)),
(("D",),(0,17,22)),
(("C","N","D",),(0,20,6)),
(("H",),(0,20,25)),
(("Q",),(0,22,4)),
(("H",),(0,22,22)),
(("Q",),(0,23,19)),
(("H",),(0,23,24)),
(("G",),(0,23,29)),
(("X","N","D",),(0,25,6)),
(("S",),(0,26,15)),
(("N",),(0,27,5)),
(("S",),(0,27,24)),
(("C","N",),(0,30,9)),
(("A",),(0,30,27)),
(("C","N",),(0,31,16)),
(("S",),(0,32,5)),
(("C","N","D",),(0,32,24)),
(("H",),(0,33,26)),
(("C","N","G",),(0,34,2)),
(("H",),(0,34,20)),
(("C","N","Q",),(0,35,10)),
(("C","N","W",),(0,36,17)),
(("Q",),(0,37,5)),
(("W",),(0,37,18)),
(("Q",),(0,37,21)),
(("X","N","H",),(0,37,27)),
(("C","V","N",),(0,40,13)),
(("H",),(0,41,1)),
(("C","N","G",),(0,41,21)),
(("Q",),(0,42,10)),
(("X","N","D",),(0,42,28)),
(("G",),(0,43,28)),
(("D",),(0,44,2)),
(("S",),(0,44,6)),
(("A",),(0,44,24)),
(("X","C","B","S",),(0,45,14)),
(("D",),(0,46,2)),
(("G",),(0,47,10)),
(("C","N","H",),(0,47,28)),
(("S",),(0,48,3)),
(("D",),(0,48,7)),
(("G",),(0,48,13)),
(("H",),(0,48,18)),
(("S",),(0,48,22)),
(("D",),(0,48,27)),
(("G",),(0,49,2)),
(("H",),(0,49,7)),
(("S",),(0,49,11)),
(("C","N","D",),(0,49,16)),
(("G",),(0,49,21)),
(("H",),(0,49,25)),
(("S",),(0,50,0)),
(("D",),(0,50,4)),
(("G",),(0,50,10)),
(("H",),(0,50,15)),
(("S",),(0,50,19)),
(("C","N","D",),(0,50,24)),
(("G",),(0,50,28)),
(("H",),(0,51,3)),
(("S",),(0,51,8)),
(("S",),(0,51,12)),
(("G",),(0,51,17)),
(("C","N","H",),(0,51,22)),
(("S",),(0,51,27)),
(("D",),(0,52,1)),
(("G",),(0,52,6)),
(("C","N","H",),(0,52,12)),
(("S",),(0,52,16)),
(("D",),(0,52,21)),
(("G",),(0,52,26)),
(("C","N","H",),(0,53,1)),
(("S",),(0,53,5)),
(("D",),(0,53,10)),
(("G",),(0,53,15)),
(("H",),(0,53,19)),
(("S",),(0,53,24)),
(("D",),(0,53,28)),
(("G",),(0,54,3)),
(("H",),(0,54,8)),
(("S",),(0,54,12)),
(("C","N","D",),(0,54,17)),
(("G",),(0,54,22)),
(("H",),(0,54,26)),
(("S",),(0,55,1)),
(("D",),(0,55,6)),
(("G",),(0,55,10)),
(("H",),(0,55,15)),
(("S",),(0,55,20)),
(("C","N","D",),(0,55,25)),
(("G",),(0,56,0)),
(("H",),(0,56,4)),
(("S",),(0,56,10)),
(("D",),(0,56,14)),
(("G",),(0,56,17)),
(("C","N","H",),(0,56,23)),
(("S",),(0,56,27)),
(("W",),(0,57,2)),
(("J",),(0,57,7)),
(("C","N","H",),(0,57,13)),
(("J",),(0,57,17)),
(("H",),(0,57,22)),
(("V","H",),(0,58,1)),
(("Z",),(0,58,10)),
(("A","Q",),(0,58,20)),
(("D",),(0,58,29)),
(("G","W",),(0,59,9)),
(("H",),(0,59,18)),
(("E",),(0,59,27)),
(("V","W",),(1,0,15)),
(("Z",),(1,0,25)),
(("A","E",),(1,1,5)),
(("D","W",),(1,1,15)),
(("G","W",),(1,1,24)),
(("V",),(1,2,12)),
(("C","W",),(1,3,2)),
(("M",),(1,3,11)),
(("D","W",),(1,3,22)),
(("G","E",),(1,4,0)),
(("H","W",),(1,4,9)),
(("C","Q",),(1,4,29)),
(("X","H",),(1,5,18)),
(("B",),(1,5,27)),
(("N","G",),(1,6,7)),
(("H",),(1,6,16)),
(("G",),(1,6,21)),
(("C","M","D",),(1,6,26)),
(("C",),(1,7,15)),
(("V","H",),(1,8,4)),
(("Z",),(1,8,13)),
(("A","Q",),(1,8,23)),
(("D",),(1,9,2)),
(("G","W",),(1,9,12)),
(("H",),(1,9,22)),
(("E",),(1,10,1)),
(("V","W",),(1,10,20)),
(("Z",),(1,10,29)),
(("A","T",),(1,11,9)),
(("D","E",),(1,11,18)),
(("G","W",),(1,11,27)),
(("V",),(1,12,16)),
(("X","W",),(1,13,5)),
(("B",),(1,13,14)),
(("N","Q",),(1,13,25)),
(("A",),(1,14,4)),
(("S","H",),(1,14,13)),
(("D",),(1,14,23)),
(("Q",),(1,15,2)),
(("C","M","E",),(1,15,23)),
(("W",),(1,15,27)),
(("E",),(1,16,1)),
(("C",),(1,16,10)),
(("N",),(1,16,19)),
(("A",),(1,16,29)),
(("S",),(1,17,8)),
(("D",),(1,17,18)),
(("G",),(1,17,27)),
(("V","A","H",),(1,18,7)),
(("Q",),(1,18,27)),
(("W",),(1,19,15)),
(("E",),(1,20,4)),
(("V","Z",),(1,20,14)),
(("V","A","W",),(1,20,24)),
(("E",),(1,21,12)),
(("W",),(1,21,22)),
(("W",),(1,22,2)),
(("C","M","W",),(1,23,9)),
(("W",),(1,23,27)),
(("E",),(1,24,7)),
(("W",),(1,24,17)),
(("Q",),(1,25,5)),
(("C",),(1,25,13)),
(("X","N","H",),(1,25,24)),
(("G",),(1,26,12)),
(("H",),(1,26,21)),
(("G",),(1,26,26)),
(("C","M","D",),(1,27,1)),
(("X","D",),(1,28,10)),
(("B",),(1,28,19)),
(("N","G",),(1,28,29)),
(("A",),(1,29,9)),
(("S","H",),(1,29,18)),
(("D",),(1,29,28)),
(("Q",),(1,30,7)),
(("C","M","W",),(1,30,26)),
(("E",),(1,31,15)),
(("G",),(1,32,22)),
(("N","A","D",),(1,33,13)),
(("N","H",),(1,33,23)),
(("S",),(1,34,2)),
(("D",),(1,34,11)),
(("H",),(1,34,20)),
(("W",),(1,34,29)),
(("E",),(1,35,8)),
(("Y",),(1,35,17)),
(("E",),(1,36,15)),
(("E",),(1,37,6)),#???
(("T",),(1,37,26)),
(("V","A","D","E",),(1,38,14)),
(("W",),(1,39,20)),
(("T",),(1,40,9)),
(("C","B","A","E",),(1,40,28)),
(("T",),(1,42,1)),
(("E",),(1,42,4)),
(("W",),(1,42,7)),
(("G",),(1,43,5)),
(("C","N","H",),(1,43,14)),
(("S",),(1,43,18)),
(("D",),(1,43,23)),
(("G",),(1,43,28)),
(("H",),(1,44,3)),
(("S",),(1,44,8)),
(("D",),(1,44,12)),
(("G",),(1,44,17)),
(("H",),(1,44,21)),
(("S",),(1,44,26)),
(("D",),(1,45,1)),
(("G",),(1,45,6)),
(("H",),(1,45,11)),
(("S",),(1,45,15)),
(("D",),(1,45,20)),
(("G",),(1,45,25)),
(("H",),(1,46,0)),
(("C","N","H",),(1,46,2)),
(("S",),(1,46,5)),
(("C","N","D",),(1,46,11)),
(("G",),(1,46,15)),
(("C","N","H",),(1,46,20)),
(("S",),(1,46,24)),
(("C","N","D",),(1,47,0)),
(("G",),(1,47,4)),
(("C","N","H",),(1,47,10)),
(("S",),(1,47,13)),
(("C","N","D",),(1,47,19)),
(("G",),(1,47,23)),
(("C","N","H",),(1,47,28)),
(("S",),(1,48,3)),
(("C","N","D",),(1,48,8)),
(("G",),(1,48,12)),
(("V","H",),(1,48,17)),
(("Z",),(1,48,26)),
(("A","Q",),(1,49,7)),
(("D",),(1,49,16)),
(("G","W",),(1,49,26)),
(("H",),(1,50,4)),
(("D","E",),(1,50,14)),
(("A",),(1,50,23)),
(("V","W",),(1,51,3)),
(("Z",),(1,51,12)),
(("A","E",),(1,51,22)),
(("D","W",),(1,52,1)),
(("G","W",),(1,52,10)),
(("H",),(1,52,20)),
(("D",),(1,53,0)),
(("A",),(1,53,9)),
(("C","W",),(1,53,19)),
(("M",),(1,53,27)),
(("D","W",),(1,54,8)),
(("G","E",),(1,54,16)),
(("H","W",),(1,54,26)),
(("G",),(1,55,5)),
(("D","Q",),(1,55,15)),
(("C",),(1,55,25)),
(("X","H",),(1,56,5)),
(("B",),(1,56,14)),
(("N","G",),(1,56,24)),
(("A","H",),(1,57,3)),
(("G",),(1,57,7)),
(("C","D",),(1,57,12)),
(("B",),(1,57,22)),
(("N",),(1,58,1)),
(("A",),(1,58,10)),
(("V","H",),(1,58,20)),
(("Z",),(1,58,28)),
(("A","Q",),(1,59,9)),
(("D",),(1,59,17)),
(("G","W",),(1,59,28)),
(("H",),(2,0,7)),
(("D","E",),(2,0,17)),
(("A",),(2,0,26)),
(("V","W",),(2,1,6)),
(("Z",),(2,1,15)),
(("A","T",),(2,1,25)),
(("D","E",),(2,2,4)),
(("G",),(2,2,13)),
(("H","W",),(2,2,23)),
(("D",),(2,3,3)),
(("A",),(2,3,12)),
(("W",),(2,3,22)),
(("C","B","M","E",),(2,4,11)),
(("W",),(2,4,29)),
(("C","B","M","Q",),(2,5,18)),
(("X","V","N","H",),(2,6,7)),
(("X","V","N",),(2,6,17)),
(("X","V","N",),(2,6,27)),
(("X","V","N",),(2,7,7)),
(("X","V","N",),(2,7,16)),
(("X",),(2,7,25)),
(("B",),(2,8,0)),
(("N",),(2,8,4)),
(("A",),(2,8,8)),
(("S",),(2,8,14)),
(("D",),(2,8,18)),
(("G",),(2,8,23)),
(("G",),(2,10,3)),
(("N","H",),(2,11,12)),
(("S",),(2,11,21)),
(("D",),(2,11,29)),
(("G",),(2,12,9)),
(("H",),(2,12,18)),
(("W",),(2,12,28)),
(("E",),(2,13,7)),
(("T",),(2,13,16)),
(("Y",),(2,13,25)),
(("W",),(2,14,4)),
(("E",),(2,14,15)),
(("G",),(2,14,23)),
(("H",),(2,15,2)),
(("S",),(2,15,12)),
(("D",),(2,15,22)),
(("B",),(2,16,1)),
(("N",),(2,16,11)),
(("S",),(2,16,21)),
(("D",),(2,17,1)),
(("G",),(2,17,10)),
(("H",),(2,17,19)),
(("W",),(2,17,28)),
(("E",),(2,18,7)),
(("T",),(2,18,17)),
(("Y",),(2,18,26)),
(("W",),(2,19,6)),
(("E",),(2,19,15)),
(("G",),(2,19,24)),
(("H",),(2,20,3)),
(("S",),(2,20,13)),
(("D",),(2,20,23)),
(("B",),(2,21,3)),
(("N",),(2,21,12)),
(("S",),(2,21,21)),
(("D",),(2,22,1)),
(("G",),(2,22,10)),
(("H",),(2,22,20)),
(("W",),(2,22,29)),
(("E",),(2,23,8)),
(("T",),(2,23,18)),
(("Y",),(2,23,27)),
(("W",),(2,24,7)),
(("E",),(2,24,16)),
(("G",),(2,24,25)),
(("H",),(2,25,5)),
(("S",),(2,25,14)),
(("D",),(2,25,24)),
(("B",),(2,26,4)),
(("N",),(2,26,13)),
(("S",),(2,26,23)),
(("D",),(2,27,2)),
(("G",),(2,27,12)),
(("H",),(2,27,22)),
(("W",),(2,28,4)),
(("E",),(2,28,17)),
(("T",),(2,29,4)),
(("H","W","E","T","Y",),(2,29,4)),
]

# delay
time.sleep(1)
# main
lastT=0
for pressInfo in TapData:
    loopGenshinImpact()
    nowT=pressInfo[1][0]*60+pressInfo[1][1]+pressInfo[1][2]/30#30fps
    time.sleep(nowT-lastT)
    lastT=nowT
    for key in pressInfo[0]:
        tap(key.lower())

print("结束")